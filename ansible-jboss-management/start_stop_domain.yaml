---
- name: Manage JBoss Domain (stop/start)
  hosts: "{{ target_host }}"
  gather_facts: false
  vars:
    jboss_home: "/u01/T24/JBOSS"
    action: "{{ action }}"          # stop_domain / start_domain
    domain_config: "{{ domain_config }}"
    host_config: "{{ host_config }}"

  tasks:

    # -----------------------------
    # Stop the entire domain safely
    # -----------------------------
    - name: Stop entire JBoss domain
      raw: |
        PIDS=$(ps -ef | grep jboss | grep -v grep | awk '{print $2}')
        if [ -n "$PIDS" ]; then
          echo "$PIDS" | xargs kill -9
        else
          echo "No JBoss domain process found"
        fi
      ignore_errors: yes
      when: action == "stop_domain"

    # -----------------------------
    # Start the entire domain
    # -----------------------------
    - name: Start entire JBoss domain using wrapper script
      raw: "{{ jboss_home }}/bin/start-domain.sh {{ domain_config }} {{ host_config }}"
      when: action == "start_domain"
